# Advanced Performance Diagnostic Procedures

## 1. Explain Plan Analysis

### Generating an Explain Plan
- Method 1: SQL Console menu → Analyze → Explain Plan
- Method 2: SQL statement: `EXPLAIN PLAN SET STATEMENT_NAME = '<name>' FOR <your_SQL_query>`

### Key Metrics to Review
- OPERATOR_DETAILS: Operators used in execution
- Execution Engine: ROW vs COLUMN engine (COLUMN is preferred for analytics)
- Table type: Column store vs Row store
- SUBTREE_COST: Relative cost of operations
- CPU time, execution time, memory consumed

### Interpreting Results
- Look for full table scans (expensive on large tables)
- Check if joins are pushed down to the engine level
- Verify aggregations happen early in the plan
- Watch for row-to-column conversions (performance penalty)

## 2. PlanViz Trace Generation and Analysis

### When to Use
- Complex queries taking >10 seconds
- SAC live connection performance issues
- Unexplained slow view previews
- Comparing performance between views

### Generating a PlanViz Trace
1. Open SQL Console in Database Explorer
2. Right-click on the query → "Generate SQL Analyzer Plan File"
3. Provide a meaningful filename
4. For long-running queries: Run in background
5. Download from Database Diagnostic Files → "other" folder

### Analyzing PlanViz
- Use HANA Studio PlanViz perspective or VS Code SQL Analyzer extension
- Key analysis points:
  - Dominant Plan Operators (top 5 by CPU time)
  - Accessed tables and remote sources
  - Row counts at each step (data volume)
  - GROUP BY and JOIN operator counts
  - Remote source round-trips (for federated queries)
- Optimization targets:
  - Reduce join complexity
  - Push filters earlier in the plan
  - Persist intermediate results for hot paths
  - Cache frequently accessed dimensions

## 3. MDS Query Diagnosis (for SAC Live Connections)

### Understanding MDS
Multi-Dimensional Services (MDS) is the query engine used by SAP Analytics Cloud to consume Datasphere analytical models via live connections.

### Extracting MDS Queries from SAC
1. Open Chrome Developer Tools → Network tab
2. Reproduce the slow action in SAC
3. Find the GetResponse request in the network log
4. Download as HAR file (Right-click → Save all as HAR)
5. In the HAR file, locate the Payload with PerformanceAnalysis data
6. Extract the MDS query from the View Source payload

### Executing MDS Queries Directly
Execute directly on HANA to isolate whether the issue is in the query or SAC rendering:
```sql
CALL SYS.EXECUTE_MDS('Analytics', '', '', '', '', '<MDS_query_string>', ?);
```
- Compare execution time to SAC response time
- If HANA is fast but SAC is slow → Network or rendering issue
- If HANA is slow → Query optimization needed
- See SAP Note 2550833, 2691501 for EXECUTE_MDS details

### Result Set Limits
- SAC Drill Limitation: Default 500 rows per table widget
- Datasphere: result_set_size_max_default = 1,000,000
- Datasphere: result_set_size_max_limit = 10,000,000
- When exceeded: "MaxResultRecords" error
- Solution: Reduce dimensions/measures or add filters
- See SAP Note 2770570 for parameter configuration

## 4. Network Performance Diagnosis

### HAR File Collection
1. Open Chrome Developer Tools (F12) → Network tab
2. Check "Preserve log" checkbox
3. Reproduce the slow operation
4. Right-click in network list → "Save all as HAR with content"
5. See SAP KBA 3405253 for detailed instructions

### Interpreting HAR Timing
- DNS Lookup: Should be <50ms
- Initial Connection: Should be <100ms
- SSL Handshake: Should be <100ms
- Waiting (TTFB): Server processing time — this is where most performance issues live
- Content Download: Network transfer time
- If Waiting is high → Server-side optimization needed
- If Content Download is high → Network bandwidth issue

## 5. Tenant Performance Analysis

### Memory Analysis
- Check System Monitor → Memory allocation trends over 4 weeks
- Rising trend without corresponding data growth = potential memory leak
- Key consumers: Persisted tables/views, complex queries, in-memory caches
- Use Allocators tab to identify top memory consumers
- See SAP Note 1969700 for HANA memory SQL collection

### CPU Analysis
- Monitor thread states and CPU utilization
- Check for MVCC (Multi-Version Concurrency Control) version buildup
- Analyze workload distribution across threads
- Identify long-running queries consuming disproportionate CPU
- See SAP Note 2114710 for HANA thread analysis

### Creating a Database Analysis User
1. System → Configuration → Database Access → Database Analysis Users
2. Provide name suffix
3. Enable "space schema access" for SQL execution
4. Generate and save credentials
5. Use credentials to access Database Explorer or HANA Cockpit

## 6. Retrieving Underlying SQL from Datasphere

### Purpose
Extract the actual SQL generated by Datasphere views to execute directly on HANA for diagnosis.

### Steps
1. Create Database Analysis User (see above)
2. Open Database Explorer via the analysis user
3. In Datasphere, locate the view's generated SQL (from SQL view definition or calculated columns)
4. In Database Explorer SQL Console, add schema prefixes to table references
5. Execute and compare results/performance with Datasphere execution
6. Use Explain Plan on the extracted SQL for detailed analysis

### Common Use Case: Function Errors
Example: DAYS_BETWEEN function error — "inconsistent datatype"
- Root cause: Function expects DATE type but receives wrong type
- Fix: Use TO_DATE() conversion: `DAYS_BETWEEN(TO_DATE(col1), TO_DATE(col2))`
- See SAP Note 2573900 for HANA 2.0 SPS03 behavior changes

## Key SAP Notes for Performance

| Note | Description |
|------|-------------|
| 1969700 | SQL Statement Collection for HANA |
| 2114710 | HANA Threads and Thread Samples FAQ |
| 2073964 | PlanViz trace generation |
| 2550833 | EXECUTE_MDS procedure reference |
| 2691501 | EXECUTE_MDS for troubleshooting |
| 2770570 | Result set size parameters |
| 2573900 | DAYS_BETWEEN behavior change HANA 2.0 SPS03 |
| 3405253 | Network trace collection with Developer Tools |
| 3575377 | Max result records for MDS |
| 3616785 | Analytics mode and data persistency |
| 3476918 | How to access HANA Cloud DB traces |
